---
- name: Forward Fail2Ban Logs to Graylog
  hosts: proxmox
  become: true
  serial: 1
  vars_files:
    - ../../group_vars/all/vault.yml

  tasks:
  - name: Configure rsyslog forwarding for Fail2Ban
    copy:
      dest: /etc/rsyslog.d/30-fail2ban-graylog.conf
      content: |
        module(load="imfile")
        
        input(type="imfile"
          File="/var/log/fail2ban.log"
          Tag="fail2ban:"
          StateFile="stat-fail2ban"
          Severity="info"
          Facility="local0")

        if $programname == 'fail2ban' then @@{{ graylog_server }}:{{ graylog_port }};RSYSLOG_SyslogProtocol23Format
        & stop
      owner: root
      group: root
      mode: '0644'
    notify: Restart rsyslog

  handlers:
    - name: Restart rsyslog
      service:
        name: rsyslog
        state: restarted